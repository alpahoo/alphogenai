app_deploy:
  runs-on: ubuntu-latest
  needs: infra_deploy
  steps:
    - uses: actions/checkout@v4

    - uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Install Wrangler
      run: npm i -g wrangler

    # âœ… Installer les deps de l'app AVANT le build
    - name: Install app deps (for Pages)
      if: hashFiles('app/**') != ''
      working-directory: app
      run: npm ci || npm i

    - name: Build app
      if: hashFiles('app/**') != ''
      working-directory: app
      run: npm run build

    - name: Deploy Worker (skip if folder absent)
      if: hashFiles('workers/**') != ''
      working-directory: workers
      env:
        CLOUDFLARE_ACCOUNT_ID: ${{ vars.CF_ACCOUNT_ID }}
        CF_API_TOKEN:         ${{ secrets.CF_API_TOKEN }}
      run: wrangler deploy

    - name: Publish Pages
      if: hashFiles('app/**') != ''
      working-directory: app
      env:
        CLOUDFLARE_ACCOUNT_ID: ${{ vars.CF_ACCOUNT_ID }}
        CF_API_TOKEN:         ${{ secrets.CF_API_TOKEN }}
      run: npx wrangler pages deploy ./out --project-name ${{ vars.CF_PAGES_PROJECT }}
