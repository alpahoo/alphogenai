  infra_deploy:
    runs-on: ubuntu-latest
    needs: test_build
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      # âœ… bonne version du setup Pulumi
      - name: Setup Pulumi CLI
        uses: pulumi/setup-pulumi@v2

      - name: Ensure Pulumi stack
        if: hashFiles('infra/**') != ''
        working-directory: infra
        env:
          PULUMI_ACCESS_TOKEN: ${{ secrets.PULUMI_ACCESS_TOKEN }}
        run: |
          pulumi stack select staging || pulumi stack init staging
          pulumi config set cfAccountId     ${{ vars.CF_ACCOUNT_ID }}     --stack staging
          pulumi config set cfDnsZone       ${{ vars.CF_DNS_ZONE }}       --stack staging
          pulumi config set cfR2Bucket      ${{ vars.CF_R2_BUCKET }}      --stack staging
          pulumi config set cfWorkerName    ${{ vars.CF_WORKER_NAME }}    --stack staging
          pulumi config set cfPagesProject  ${{ vars.CF_PAGES_PROJECT }}  --stack staging

      - name: Pulumi preview
        if: hashFiles('infra/**') != ''
        uses: pulumi/actions@v4
        with:
          command: preview
          stack-name: staging
          work-dir: infra
        env:
          PULUMI_ACCESS_TOKEN: ${{ secrets.PULUMI_ACCESS_TOKEN }}
          PULUMI_CONFIG_PASSPHRASE: ""
          # ðŸ‘‡ le provider Cloudflare attend ce nom EXACT
          CLOUDFLARE_API_TOKEN: ${{ secrets.CF_API_TOKEN }}

      - name: Pulumi up
        if: hashFiles('infra/**') != ''
        uses: pulumi/actions@v4
        with:
          command: up
          stack-name: staging
          work-dir: infra
        env:
          PULUMI_ACCESS_TOKEN: ${{ secrets.PULUMI_ACCESS_TOKEN }}
          PULUMI_CONFIG_PASSPHRASE: ""
          # ðŸ‘‡ idem
          CLOUDFLARE_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          # Ces vars sont utilisÃ©es par ton programme Pulumi (index.ts)
          CF_ACCOUNT_ID:    ${{ vars.CF_ACCOUNT_ID }}
          CF_DNS_ZONE:      ${{ vars.CF_DNS_ZONE }}
          CF_R2_BUCKET:     ${{ vars.CF_R2_BUCKET }}
          CF_WORKER_NAME:   ${{ vars.CF_WORKER_NAME }}
          CF_PAGES_PROJECT: ${{ vars.CF_PAGES_PROJECT }}
